from flask import g, request
#from werkzeug import exceptions as ex
from override_flask import make_json_app

from config import CURRENT_EVENT
from helper import permission_required
import model.db as db
import api.user as user_api

app = make_json_app(__name__,)
user_api.mix(app)

# the limited public "guest" account is automatically used (by client) for
# most stuff that doesn't require permission


@app.before_request
def before_request():
	# put the request args in a mutable dict so we can pre-process them
	g.args = dict(request.args)
	if request.json:
		# if json is sent, merge that into the args
		g.args.update(request.json)
	print g.args

	# below stuff (g.notify & g.error) isn't really used... consider removing
	# an array that holds notifications (like non-fatal errors or important messages)
	#g.notify = []


# @app.after_view
# def after_view(rv):
# 	# check to see that it's json, if not then return
# 	if not type(rv) in (dict, list):
# 		return
# 	#put stuff from g in response
# 	return


@app.route('/')
def index():
	return """
		<!DOCTYPE html>
		<html>
			<head>
				<title>CSD</title>
			</head>
			<body>
				<p>put docs generated by sphinx here?</p>
			</body>
		</html>
	"""


@app.route('/admin/reset', methods=['DELETE'])
@permission_required('reset_db')
def reset_db():
	db.clear()
	db.defaults()
	return {'notify': 'reset successful'}


@app.route('/admin/scrape', methods=['POST'])
@permission_required()
def scrape():
	from scraper import scraper
	scraper.event_names()
	scraper.event_details()
	scraper.tpids()
	scraper.team_details()
	scraper.match(CURRENT_EVENT)
	return {'notify': 'scrape successful'}

if __name__ == "__main__":
	app.run(debug=True)
